## DCPU Profiler

This is an (optionally) interactive commandline tool that can analyze
profiling data generated by the `prof` package.

It accepts a number of textual commands which serve to display various
types of data about a program we generated profiling data for. Options to
these commands allow us to sort the data in different ways and to
filter out unnecessary clutter.


### Usage

Read the given file:

    $ dcpu-prof data.prof

Type 'help' in the program for a list of commands.

In interactive mode, the commands can be typed into the shell as
needed. We can also run the program non-interactively. By supplying
the desired command as commandline flags when invoking `dcpu-prof`.
This makes it generate the output for our command and then exit.
For example:

	$ dcpu-prof -top -file ../testdata/strpbrk_test.prof 
	[*] 848 sample(s), 1985 cycle(s)
		  591  69.69%     1454  73.25% $DCPU_PATH/string/strchr.dasm
		  152  17.92%      342  17.23% $DCPU_PATH/string/strlen.dasm
		   90  10.61%      159   8.01% $DCPU_PATH/string/strpbrk.dasm
		   11   1.30%       22   1.11% $DCPU_PATH/string/strpbrk_test.dasm
		    2   0.24%        4   0.20% $DCPU_PATH/test/assert_ez.dasm
		    2   0.24%        4   0.20% $DCPU_PATH/test/assert_eq.dasm
	$ 

### Top Example

Here is an excerpt of an example usage of the `top` command.
It lists only the usage of functions or files. This is a good starting point
when profiling code. As it gives a rough overview of where most of the CPU
time is spent without going into too much detail.

	top
	[*] 46 sample(s), 68 cycle(s)
		   43  93.48%       64  94.12% foo
		    3   6.52%        4   5.88% main

	top -file
	[*] 48 sample(s), 72 cycle(s)
		   48 100.00%       72 100.00% testdata/func_test.dasm


The table shows 5 columns, depending on whether you are viewing
function or file listings:

* **COUNT**: This is the cumulative total number of times each instruction
  inside this function was executed.

* **COUNT PERC**: This is the percentage of the total count for all
  returned samples.
  
* **COST**: This is the cumulative cycle cost for all instructions inside
  this function.
  
* **COST PERC**: This is the cost percentage of the total cost for the
  returned samples.
  
* **LABEL**: This is the name of the function or the source file,
  depending on whether we are viewing file mode or not.


### List Example

Here is an example of the `list` command output:

	list
	[*] ===> foo (func_test.dasm)
	[*] 46 sample(s), 78 cycle(s)

		   1        1   009: def foo
		   1        1   010: 	set i, 0
		                011: 
		                012: :foo_loop
		  11       32   013: 	ife i, 10
		   1        2   014: 		return
		  10       20   015: 	add i, 1
		  10       10   016: 	shr a, 1
		  10       10   017: 	set pc, foo_loop
		   2        2   018: end

	[*] ===> main (func_test.dasm)
	[*] 3 sample(s), 4 cycle(s)

		   1        1   005: 	set a, 0xffff
		   1        2   006: 	jsr foo
		   1        1   007: end

	list -file
	[*] ===> dcpu/testdata/func_test.dasm
	[*] 50 sample(s), 85 cycle(s)

		   1        2   001: 	jsr main
		   1        2   002: 	exit
		                003: 
		                004: def main
		   1        1   005: 	set a, 0xffff
		   1        2   006: 	jsr foo
		   1        1   007: end
		                008: 
		   1        1   009: def foo
		   1        1   010: 	set i, 0
		                011: 
		                012: :foo_loop
		  11       32   013: 	ife i, 10
		   1        2   014: 		return
		  10       20   015: 	add i, 1
		  10       10   016: 	shr a, 1
		  10       10   017: 	set pc, foo_loop
		   1        1   018: end


It lists the sources for all functions that match the filter specified in
the command. Using `list` without a filter, defaults to showing all function
sources. This display comes with the original source code, along with some
extra data in the first two columns:

* **COUNT**: This is the total number of times the instruction was executed.
  
* **COST**: This is the total cycle cost for this instruction.
  
The output of this command without a filter can be overwhelming in a large
codebase, so it is practical to use it in combination with `top`. Use `top`
to find a function or file that consumes the most cycles and then dive into
the detailed usage with `list`:

	list -file -f strchr
	[*] ===> $DCPU_PATH/string/strchr.dasm 17-26
	[*] 591 sample(s), 1454 cycle(s)

		 148      441   017:    ife [a], b
		   3        3   018:       set pc, pop
		 145      430   019:    ife [a], 0
		   5       10   020:       set pc, strchr_not_found
		 140      280   021:    add a, 1
		 140      280   022:    set pc, strchr
		                023: 
		                024: :strchr_not_found
		   5        5   025:    set a, 0
		   5        5   026:    set pc, pop


As with `top`, we can specify the `-file` flag in this command to list
full file contents, instead of just specific functions. This is useful for
code where no function calls are used.


### License

DCPU, 0x10c and related materials are Copyright 2012 Mojang.

Unless otherwise stated, all of the work in this project is subject to a
1-clause BSD license. Its contents can be found in the enclosed LICENSE file.
