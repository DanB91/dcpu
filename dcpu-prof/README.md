## DCPU Profiler

This is an (optionally) interactive commandline tool that can analyze
profiling data generated by the `prof` package.

It accepts a number of textual commands which serve to display various
types of data about a program we generated profiling data for. Options to
these commands allow us to sort the data in different ways and to
filter out unnecessary clutter.


### Usage

Read the given file:

    $ dcpu-prof data.prof

Type 'help' in the program for a list of commands.

In interactive mode, the commands can be typed into the shell as
needed. We can also run the program non-interactively. By supplying
the desired command as commandline flags when invoking `dcpu-prof`.
This makes it generate the output for our command and then exit.
For example:

	$ dcpu-prof -top -file ../testdata/strpbrk_test.prof 
	[*] 848 sample(s), 1985 cycle(s)
		  591  69.69%     1454  73.25% $DCPU_PATH/string/strchr.dasm
		  152  17.92%      342  17.23% $DCPU_PATH/string/strlen.dasm
		   90  10.61%      159   8.01% $DCPU_PATH/string/strpbrk.dasm
		   11   1.30%       22   1.11% $DCPU_PATH/string/strpbrk_test.dasm
		    2   0.24%        4   0.20% $DCPU_PATH/test/assert_ez.dasm
		    2   0.24%        4   0.20% $DCPU_PATH/test/assert_eq.dasm
	$ 

### Top Example

Here is an excerpt of an example usage of the `top` command.
It lists only the usage of functions or files. This is a good starting point
when profiling code. As it gives a rough overview of where most of the CPU
time is spent without going into too much detail.

	top
	[*] 48 sample(s), 110 cycle(s)
		   42  87.50%       98  89.09% memchr
		    4   8.33%        8   7.27% assert_eq
		    2   4.17%        4   3.64% assert_ez

	top -file
	[*] 108 sample(s), 225 cycle(s)
		   70  64.81%      157  69.78% $DCPU_PATH/string/memcmp.dasm
		   28  25.93%       48  21.33% $DCPU_PATH/string/_test.dasm
		    8   7.41%       16   7.11% $DCPU_PATH/string/assert_eq.dasm
		    2   1.85%        4   1.78% $DCPU_PATH/string/assert_ez.dasm


The table shows 5 columns, depending on whether you are viewing
function or file listings:

* **COUNT**: This is the cumulative total number of times each instruction
  inside this function was executed.

* **COUNT PERC**: This is the percentage of the total count for all
  returned samples.
  
* **COST**: This is the cumulative cycle cost for all instructions inside
  this function.
  
* **COST PERC**: This is the cost percentage of the total cost for the
  returned samples.
  
* **LABEL**: This is the name of the function or the source file,
  depending on whether we are viewing file mode or not.


### List Example

Here is an example of the `list` command output:

	list
	[*] ===> $DCPU_PATH/string/memchr.dasm 15-29
	[*] 42 sample(s), 98 cycle(s)

		   3       11   015:   ife 0, c ; num is zero -- No compare needed.
		   1        1   016:     set pc, pop
		                017: 
		                018: :memchr_loop
		   8       23   019:   ife [a], b
		   1        1   020:     set pc, pop
		   7       14   021:   sub c, 1
		   7       20   022:   ife c, 0
		   1        2   023:     set pc, memchr_ret
		   6       12   024:   add a, 1
		   6       12   025:   set pc ,memchr_loop
		                026: 
		                027: :memchr_ret
		   1        1   028:   set a, 0
		   1        1   029:   set pc, pop

	[*] ===> $DCPU_PATH/test/assert_eq.dasm 8-10
	[*] 4 sample(s), 8 cycle(s)

		   2        6   008:   ifn a, b
		                009:     panic assert_eq_str
		   2        2   010:   set pc, pop

	[*] ===> $DCPU_PATH/test/assert_ez.dasm 8-10
	[*] 2 sample(s), 4 cycle(s)

		   1        3   008:   ifn a, 0
		                009:     panic assert_ez_str
		   1        1   010:   set pc, pop



It lists the sources for all functions that match the filter specified in
the command. Using `list` without a filter, defaults to showing all function
sources. This display comes with the original source code, along with some
extra data in the first two columns:

* **COUNT**: This is the total number of times the instruction was executed.
  
* **COST**: This is the total cycle cost for this instruction.
  
The output of this command without a filter can be overwhelming in a large
codebase, so it is practical to use it in combination with `top`. Use `top`
to find a function or file that consumes the most cycles and then dive into
the detailed usage with `list`:

	list -file -f strchr
	[*] ===> $DCPU_PATH/string/strchr.dasm 17-26
	[*] 591 sample(s), 1454 cycle(s)

		 148      441   017:    ife [a], b
		   3        3   018:       set pc, pop
		 145      430   019:    ife [a], 0
		   5       10   020:       set pc, strchr_not_found
		 140      280   021:    add a, 1
		 140      280   022:    set pc, strchr
		                023: 
		                024: :strchr_not_found
		   5        5   025:    set a, 0
		   5        5   026:    set pc, pop


As with `top`, we can specify the `-file` flag in this command to list
full file contents, instead of just specific functions. This is useful for
code where no function calls are used.


### License

DCPU, 0x10c and related materials are Copyright 2012 Mojang.

Unless otherwise stated, all of the work in this project is subject to a
1-clause BSD license. Its contents can be found in the enclosed LICENSE file.
